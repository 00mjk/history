<!DOCTYPE html>
<html>
  <body>
    <h1>Controls</h1>

    <p>
      <label><input type="checkbox" id="blocker" /> block</label>
    </p>
    <p>
      <span>back &amp; forward: </span><br />
      <button onclick="goBack()">back</button>
      <button onclick="goForward()">forward</button>
    </p>
    <p>
      <span>regular links: </span><br />
      <a href="/unload-history">home</a>
      <a href="/unload-history-one">one</a>
      <a href="/unload-history-two">two</a>
    </p>
    <p>
      <span>pushState &amp; replaceState: </span><br />
      <a href="/unload-history" onclick="return pushLink(this)">pushState(home)</a>
      <a href="/unload-history-one" onclick="return pushLink(this)">pushState(one)</a>
      <a href="/unload-history-two" onclick="return pushLink(this)">pushState(two)</a>
      <a href="/unload-history-three" onclick="return replaceLink(this)">replaceState(three)</a>
    </p>

    <h1>Test Scenarios</h1>

    <p>
      <ul>
        <li>Click block - Click back - You should be prompted to stay</li>
        <li>Click block - Click home - You should be prompted to stay</li>
        <li>Click block - Click one - You should be prompted to stay</li>
        <li>Click block - Close the tab - You should be prompted to stay</li>
        <li>Click pushState(one) - Click block - Click back - You should still be at /unload-history-one</li>
        <li>Click pushState(one) - Click block - Click pushState(two) - You should still be at /unload-history-one</li>
        <li>Click pushState(one) - Click pushState(two) - Click back - Click block - Click back - You should still be at /unload-history-one</li>
        <li>Click pushState(one) - Click pushState(two) - Click back - Click block - Click forward - You should still be at /unload-history-one</li>
        <li>Click pushState(one) - Click pushState(two) - Click replaceState(three) - Click block - Click back - You should still be at /unload-history-three</li>
      </ul>
    </p>

    <script src="history.js"></script>
    <script>
      var h = History.createBrowserHistory();

      // Blocker

      var blocker = document.getElementById('blocker');
      var unblock;
      blocker.addEventListener('change', () => {
        if (blocker.checked) {
          unblock = h.block(({ action, location }) => {
            console.log(`blocked ${action} to ${location.pathname}`)

            // Use a setTimeout here to give the router time to reset
            // the URL back to what it was before we blocked the tx.
            setTimeout(() => {
              if (window.confirm(`Are you sure you want to go to ${location.pathname}?`)) {
                // Reset the blocker so the next tx is allowed.
                blocker.checked = false;
                unblock();
                // Replay the previous tx.
                h.navigate(location, { replace: action === 'REPLACE' });
              }
            }, 100);
          });
        } else if (unblock) {
          unblock();
          unblock = undefined;
        }
      });

      // Navigation

      function pushLink(link) {
        h.navigate(link.getAttribute('href'));
        return false; // preventDefault
      }

      function replaceLink(link) {
        h.navigate(link.getAttribute('href'), { replace: true });
        return false; // preventDefault
      }

      function goBack() {
        h.back();
      }

      function goForward() {
        h.forward();
      }
    </script>
  </body>
</html>

